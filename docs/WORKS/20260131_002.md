# 작업: 뉴스 임베딩 파이프라인 추가

## 배경

뉴스 유사도 검색과 클러스터링을 위해 벡터 임베딩이 필요하다.

**용도:**
- 유사 뉴스 검색 (새 뉴스와 비슷한 과거 뉴스 찾기)
- 클러스터링 (비슷한 뉴스 묶기, 중복 제거)
- 종목 추론 (과거 뉴스가 연결된 종목 참고)

**현재 상태:**
- `news_raw` 테이블에 뉴스 저장됨
- 기업명 추출 배치는 09:00, 21:00 실행
- sentence-transformers, pgvector 의존성은 이미 있음

## 목표

뉴스 임베딩 생성 및 저장 파이프라인 구현

## 범위

**할 것:**
- PostgreSQL pgvector 확장 활성화 (Flyway 마이그레이션)
- 임베딩 저장 테이블 생성
- 임베딩 생성 함수 (sentence-transformers)
- 임베딩 배치 스케줄러 (00:00, 12:00)
- 중복 실행 방지
- 수동 실행 엔드포인트

**안 할 것:**
- 유사도 검색 API (다음 작업)
- 클러스터링 (다음 작업)

## 임베딩 설정

| 항목 | 값 |
|------|-----|
| 대상 | 제목 + 본문 (concat) |
| 모델 | KURE-v1 (nlpai-lab/KURE-v1) |
| 스케줄 | 매일 00:00, 12:00 |

## 테이블 설계

### news_embedding

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | BIGSERIAL | PK |
| news_id | BIGINT | FK → news_raw.id, UNIQUE |
| embedding | vector(1024) | 임베딩 벡터 |
| created_at | TIMESTAMP | 생성 시각 |

## 마이그레이션 파일

위치: `apps/api/src/main/resources/db/migration/V7__add_news_embedding.sql`

```sql
CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE news_embedding (
    id           BIGSERIAL PRIMARY KEY,
    news_id      BIGINT NOT NULL UNIQUE REFERENCES news_raw(id),
    embedding    vector(1024) NOT NULL,
    created_at   TIMESTAMP NOT NULL
);

CREATE INDEX idx_news_embedding_vector ON news_embedding USING ivfflat (embedding vector_cosine_ops);
```

## 파일 구조

```
analyzer/
  ├─ main.py          ← 스케줄러에 임베딩 배치 추가
  ├─ batch.py         ← 기존 (기업명 추출)
  ├─ embedding.py     ← 신규: 임베딩 생성/저장 로직
  ├─ models.py        ← NewsEmbedding 모델 추가
  └─ ...
```

## 모델 정의

```python
from pgvector.sqlalchemy import Vector

class NewsEmbedding(Base):
    __tablename__ = "news_embedding"
    
    id = Column(BigInteger, primary_key=True)
    news_id = Column(BigInteger)
    embedding = Column(Vector(1024))
    created_at = Column(DateTime)
```

## 배치 로직

1. news_embedding에 없는 news_raw 중 가장 오래된 것 조회
2. 제목 + 본문 concat하여 임베딩 생성
3. news_embedding에 저장
4. 미처리 뉴스 없을 때까지 반복
5. 에러 시 건너뛰고 계속

## 엔드포인트

```
POST /embedding/start
→ 수동으로 임베딩 배치 시작

GET /embedding/status
→ 현재 실행 상태 반환
```

## 완료 조건

- Flyway 마이그레이션 성공 (pgvector 확장, 테이블 생성)
- 서버 시작 시 스케줄러 자동 시작
- 00:00, 12:00에 임베딩 배치 자동 실행
- POST /embedding/start로 수동 실행 가능
