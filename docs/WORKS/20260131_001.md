# 작업: 배치 스케줄러 추가

## 배경

Analyzer는 뉴스에서 기업명을 추출하는 LLM 파이프라인이다.
- `news_raw` 테이블에 뉴스가 쌓임
- `news_company_extraction` 테이블에 처리 결과가 저장됨
- 아직 `news_company_extraction`에 없는 뉴스가 "미처리 뉴스"

현재는 `POST /extract`로 뉴스 1개씩 수동 처리만 가능하다.
이를 자동화하여 미처리 뉴스를 일괄 처리하는 배치 스케줄러가 필요하다.

## 목표

미처리 뉴스를 자동으로 처리하는 배치 스케줄러 구현

## 범위

**할 것:**
- APScheduler 의존성 추가
- 배치 처리 함수
- 스케줄러 설정 (매일 09:00, 21:00)
- 중복 실행 방지
- 에러 발생 시 해당 뉴스 건너뛰고 계속 진행
- 수동 실행 및 상태 확인 엔드포인트

**안 할 것:**
- 병렬 처리
- 시간 제한

## 의존성 추가

```bash
poetry add apscheduler
```

## 배치 처리 로직

1. 미처리 뉴스 중 가장 오래된 것(id 오름차순) 1개 조회
2. 기존 `extract_companies()` 함수로 처리 및 저장
3. 에러 발생 시 해당 뉴스 건너뛰고 다음으로 (status를 'failed'로 저장)
4. 미처리 뉴스가 없을 때까지 반복
5. 이미 배치가 실행 중이면 새 배치 시작 안 함 (중복 실행 방지)

## 스케줄 설정

- 매일 09:00 실행
- 매일 21:00 실행
- APScheduler cron 트리거 사용

## 엔드포인트 추가

```
POST /batch/start
→ 수동으로 배치 시작
→ 이미 실행 중이면 {"status": "already_running"} 반환

GET /batch/status
→ 현재 배치 실행 상태 반환
→ {"running": true/false}
```

## 파일 구조

```
analyzer/
  ├─ main.py          ← 스케줄러 초기화, 엔드포인트 추가
  ├─ database.py
  ├─ models.py
  ├─ llm.py
  └─ batch.py         ← 신규: 배치 처리 로직
```

## 완료 조건

- 서버 시작 시 스케줄러 자동 시작
- 09:00, 21:00에 배치 자동 실행
- `POST /batch/start`로 수동 실행 가능
- `GET /batch/status`로 상태 확인 가능
- 에러 발생한 뉴스는 건너뛰고 계속 진행
