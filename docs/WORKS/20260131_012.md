# Extraction 로그 상세화

## 배경

- LLM 호출 시 간헐적으로 18분 이상 소요되는 문제 발생
- 원인 파악을 위해 상세 로그 필요

## 목표

LLM 호출 전후로 상세 로그 추가하여 문제 발생 시 원인 파악 가능하게 함

## 관련 파일

```
apps/news-analyzer/extraction/service.py
apps/news-analyzer/extraction/job.py
```

## 할 것

### 1. extraction/service.py 로그 추가

- LLM 호출 시작 시간, 종료 시간
- 입력 텍스트 길이
- 소요 시간

```python
import time

def extract_companies(text: str) -> list[str]:
    text_length = len(text)
    logger.info(f"LLM 호출 시작 - 텍스트 길이: {text_length}")
    
    start_time = time.time()
    llm = ChatOllama(...)
    response = llm.invoke(...)
    elapsed = time.time() - start_time
    
    raw = response.content.strip()
    logger.info(f"LLM 호출 완료 - 소요시간: {elapsed:.2f}초, 응답: {raw}")
    ...
```

### 2. extraction/job.py 로그 추가

- 배치 시작/종료
- 처리 중인 news_id
- 개별 뉴스 처리 소요 시간

```python
def _process_all():
    logger.info("배치 시작")
    count = 0
    while True:
        ...
        logger.info(f"처리 시작 - news_id={news.id}, title={news.title[:50]}")
        start_time = time.time()
        
        companies = extract_companies(news.raw_text)
        
        elapsed = time.time() - start_time
        logger.info(f"처리 완료 - news_id={news.id}, 소요시간: {elapsed:.2f}초, 결과: {companies}")
        count += 1
        ...
    logger.info(f"배치 종료 - 총 {count}건 처리")
```

### 3. 로컬 테스트

```bash
cd apps/news-analyzer
uvicorn main:app --port 8000

# 다른 터미널
curl -X POST http://localhost:8000/extraction/job/start

# 로그 확인
```

### 4. 기대 로그 형태

```
2026-01-31 22:00:00 [INFO] extraction.job: 배치 시작
2026-01-31 22:00:00 [INFO] extraction.job: 처리 시작 - news_id=27, title=한국 가족 여행객, 방학철 푸꾸옥 집중...
2026-01-31 22:00:00 [INFO] extraction.service: LLM 호출 시작 - 텍스트 길이: 892
2026-01-31 22:00:03 [INFO] extraction.service: LLM 호출 완료 - 소요시간: 3.21초, 응답: 쉐라톤, 메리어트 인터내셔널
2026-01-31 22:00:03 [INFO] extraction.job: 처리 완료 - news_id=27, 소요시간: 3.25초, 결과: ['쉐라톤', '메리어트 인터내셔널']
...
2026-01-31 22:05:00 [INFO] extraction.job: 배치 종료 - 총 50건 처리
```

## 안 할 것

- timeout 추가 (원인 파악 후 결정)
- 모델 변경
