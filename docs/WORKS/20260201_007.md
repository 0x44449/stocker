# 기업명-종목 매핑 테이블 및 자동 매칭

## 배경

- LLM이 뉴스에서 추출한 기업명을 종목코드와 연결해야 함
- 자동 매칭은 정확 일치만 처리, 나머지는 수동 매핑 필요
- 향후 파인튜닝을 위한 학습 데이터 수집 목적

## 목표

1. 매핑 결과 저장 테이블 생성
2. 뉴스 분석 시 정확 일치 자동 매칭 실행

## 관련 파일

```
apps/api/src/main/resources/db/migration/
apps/news-analyzer/
```

## 할 것

### 1. company_name_mapping 테이블 생성

```sql
CREATE TABLE company_name_mapping (
    id BIGSERIAL PRIMARY KEY,
    news_id BIGINT NOT NULL REFERENCES news_raw(id),
    extracted_name VARCHAR(200) NOT NULL,      -- LLM이 추출한 기업명
    matched_stock_code VARCHAR(20),            -- 매핑된 종목코드 (nullable)
    match_type VARCHAR(20) NOT NULL,           -- auto_exact / manual / none
    verified BOOLEAN NOT NULL DEFAULT FALSE,   -- 사람이 검증했는지
    feedback TEXT,                             -- 오류 사유, 메모 등
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_company_name_mapping_news_id ON company_name_mapping(news_id);
CREATE INDEX idx_company_name_mapping_match_type ON company_name_mapping(match_type);
CREATE INDEX idx_company_name_mapping_verified ON company_name_mapping(verified);
```

**match_type 값:**
- `auto_exact`: 자동 매칭 (정확 일치)
- `manual`: 수동 매핑
- `none`: 미매칭

### 2. 자동 매칭 로직 (news-analyzer)

뉴스 extraction 시 기업명 추출 후:

```python
def match_company_to_stock(extracted_name: str) -> tuple[str | None, str]:
    """
    Returns: (stock_code or None, match_type)
    """
    # stock_master에서 name_kr 또는 name_kr_short 정확 일치 검색
    stock = find_stock_by_name(extracted_name)
    
    if stock:
        return (stock.stock_code, "auto_exact")
    else:
        return (None, "none")
```

**정확 일치 기준:**
- stock_master.name_kr = extracted_name
- stock_master.name_kr_short = extracted_name
- 둘 중 하나 일치하면 매칭

### 3. 매핑 결과 저장

뉴스 1개당 추출된 기업명 N개 → N개 행 저장

```python
for company_name in extracted_companies:
    stock_code, match_type = match_company_to_stock(company_name)
    
    save_mapping(
        news_id=news_id,
        extracted_name=company_name,
        matched_stock_code=stock_code,
        match_type=match_type,
        verified=False
    )
```

## 안 할 것

- 유사도 매칭 (나중에)
- 수동 매핑 UI (Phase 2)
- 별칭 테이블 (데이터 쌓이면)

## 완료 조건

- [ ] 마이그레이션 파일 생성 (V9__add_company_name_mapping.sql)
- [ ] news-analyzer에서 자동 매칭 로직 구현
- [ ] 뉴스 분석 시 매핑 결과 저장
