# KRX 인증/다운로드 로그 추가

## 배경

- 종목 마스터 크롤링 시 CSV 다운로드가 null 반환
- curl로 직접 호출하면 정상 동작
- OTP 응답이 "LOGOUT"으로 오는 것으로 보아 세션이 유효하지 않음
- 세션 ID 값 확인 필요

## 목표

KRX 로그인, OTP 생성, 파일 다운로드 과정에 로그 추가 (세션 ID 값 포함)

## 관련 파일

```
apps/api/src/main/java/com/hanzi/stocker/ingest/krx/common/KrxAuthClient.java
apps/api/src/main/java/com/hanzi/stocker/ingest/krx/common/KrxSessionProvider.java
apps/api/src/main/java/com/hanzi/stocker/ingest/krx/common/KrxFileClient.java
```

## 할 것

### KrxAuthClient.java

```java
public KrxSession login(String userId, String password) {
    log.info("KRX 로그인 시도 - userId: {}", userId);
    
    // ... 기존 로직
    
    if (sessionId != null) {
        log.info("KRX 로그인 성공 - sessionId: {}", sessionId);
    } else {
        log.error("KRX 로그인 실패 - 세션 ID 추출 실패, cookies: {}", response.getHeaders().get(HttpHeaders.SET_COOKIE));
    }
    
    return sessionId != null ? new KrxSession(sessionId) : null;
}
```

### KrxSessionProvider.java

```java
public KrxSession get() {
    if (session != null && !session.isExpired()) {
        log.debug("기존 세션 재사용");
        return session;
    }

    synchronized (lock) {
        if (session == null || session.isExpired()) {
            log.info("새 세션 획득 시도");
            session = authClient.login(config.getUsername(), config.getPassword());
            if (session == null) {
                log.error("세션 획득 실패");
            }
        }
        return session;
    }
}
```

### KrxFileClient.java

```java
private String generateOtp(KrxSession session, String referer, MultiValueMap<String, String> formData) {
    log.info("OTP 생성 시도 - cookie: {}, referer: {}", session.toCookieValue(), referer);
    log.debug("OTP formData: {}", formData);
    
    String otp = restClient.post()
            // ... 기존 로직
            .body(String.class);

    if (otp == null || otp.isBlank()) {
        log.error("OTP 생성 실패 - 빈 응답");
        throw new IllegalStateException("Failed to generate OTP: empty response");
    }

    log.info("OTP 생성 성공 - otp: {}", otp.trim());
    return otp.trim();
}

private byte[] downloadFile(KrxSession session, String referer, String otp) {
    log.info("파일 다운로드 시도 - otp: {}", otp);
    
    // ... 기존 로직
    
    byte[] result = restClient.post()
            // ...
            .body(byte[].class);
    
    if (result == null) {
        log.error("파일 다운로드 실패 - null 응답");
    } else {
        log.info("파일 다운로드 성공 - {} bytes", result.length);
    }
    
    return result;
}

public byte[] download(KrxSession session, String referer, MultiValueMap<String, String> formData) {
    log.info("KRX 파일 다운로드 시작");
    String otp = generateOtp(session, referer, formData);
    return downloadFile(session, referer, otp);
}
```

## 완료 조건

- 로그인 성공 시 세션 ID 값 로그 확인 가능
- OTP 생성 시 Cookie 헤더 값 로그 확인 가능
- 어느 단계에서 문제가 발생하는지 파악 가능
