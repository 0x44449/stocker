# KRX 종목 마스터 크롤러

## 배경

- 뉴스에서 추출한 기업명을 종목코드와 매칭하려면 종목 마스터 데이터가 필요
- 현재 stock_price_daily_raw에 종목명이 있지만, 매칭 전용 테이블이 없음
- KRX에서 종목 기본정보를 크롤링하여 별도 테이블에 저장

## 목표

KRX 종목 기본정보를 매일 크롤링하여 stock_master 테이블에 저장

## 범위

**할 것:**
- stock_master 테이블 생성 (Flyway 마이그레이션)
- KrxMasterCrawlEngine 구현 (기존 KrxFileClient 활용)
- KrxMasterCrawlScheduler 구현 (매일 09:10)
- Upsert 로직 (isin_code 기준)

**안 할 것:**
- KOSDAQ 크롤링 (현재는 KOSPI만)
- 뉴스-종목 매칭 로직 (다음 작업)
- 수동 트리거 엔드포인트 (필요시 별도 작업)

## 테이블 설계

### stock_master

| 컬럼 | 타입 | 설명 |
|------|------|------|
| isin_code | TEXT, PK | 표준코드 |
| stock_code | TEXT, UNIQUE | 단축코드 |
| name_kr | TEXT | 한글 종목명 |
| name_kr_short | TEXT | 한글 종목약명 |
| name_en | TEXT | 영문 종목명 |
| listed_date | DATE | 상장일 |
| market | TEXT | 시장구분 |
| security_type | TEXT | 증권구분 |
| department | TEXT | 소속부 (nullable) |
| stock_type | TEXT | 주식종류 |
| face_value | BIGINT | 액면가 |
| listed_shares | BIGINT | 상장주식수 |
| ingested_at | TIMESTAMPTZ | 수집 시각 |

## 크롤링 설정

- **URL**: dbms/MDC/STAT/standard/MDCSTAT01901
- **Referer**: https://data.krx.co.kr/contents/MDC/MDI/mdiLoader/index.cmd?menuId=MDC0201020201
- **formData**:
  - locale=ko_KR
  - mktId=STK (KOSPI)
  - share=1
  - csvxls_isNo=false
  - name=fileDown
- **인코딩**: EUC-KR
- **스케줄**: 매일 09:10

## CSV 컬럼 매핑

| CSV 헤더 | 테이블 컬럼 |
|----------|-------------|
| 표준코드 | isin_code |
| 단축코드 | stock_code |
| 한글 종목명 | name_kr |
| 한글 종목약명 | name_kr_short |
| 영문 종목명 | name_en |
| 상장일 | listed_date |
| 시장구분 | market |
| 증권구분 | security_type |
| 소속부 | department |
| 주식종류 | stock_type |
| 액면가 | face_value |
| 상장주식수 | listed_shares |

## 파일 구조

```
apps/api/src/main/java/com/hanzi/stocker/ingest/krx/master/
├── KrxMasterCrawlEngine.java      # 크롤링 + 파싱 + 저장
├── KrxMasterCrawlScheduler.java   # 스케줄러
├── StockMasterEntity.java         # 엔티티
└── StockMasterRepository.java     # JPA 리포지토리
```

## 마이그레이션 파일

위치: `apps/api/src/main/resources/db/migration/V8__add_stock_master.sql`

```sql
CREATE TABLE stock_master (
    isin_code TEXT PRIMARY KEY,
    stock_code TEXT NOT NULL UNIQUE,
    name_kr TEXT NOT NULL,
    name_kr_short TEXT NOT NULL,
    name_en TEXT,
    listed_date DATE,
    market TEXT NOT NULL,
    security_type TEXT,
    department TEXT,
    stock_type TEXT,
    face_value BIGINT,
    listed_shares BIGINT,
    ingested_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_stock_master_stock_code ON stock_master(stock_code);
CREATE INDEX idx_stock_master_name_kr_short ON stock_master(name_kr_short);
```

## 완료 조건

- Spring 앱 실행 시 Flyway 마이그레이션 성공
- 09:10에 스케줄러 실행되어 stock_master 테이블에 데이터 저장
- 재실행 시 upsert 동작 (중복 없이 업데이트)
