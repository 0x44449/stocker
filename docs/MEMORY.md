# 뉴스-종목 연관성 분석 파이프라인 - 작업 메모

> 마지막 업데이트: 2026-01-30

## 배경

- 뉴스 수집은 이미 구현됨 (`news_raw` 테이블에 저장 중)
- 이제 수집된 뉴스가 어떤 종목과 연관있는지 분석 필요
- 한 번에 처리 어려움 → 파이프라인으로 단계별 처리
- 비용 최소화 원칙 → API 비용 없이 로컬 LLM 사용

## 목표

수집된 뉴스를 분석해서 어떤 종목과 연관이 있는지 파악하는 파이프라인 구축

## 파이프라인 스테이지 (초안)

```
[뉴스 원문]
    ↓
Stage 1: 직접 매칭 ← 현재 여기 설계 중
    - 뉴스 본문에서 직접 언급된 기업명 추출
    - 결과: 직접 언급 종목 리스트
    ↓
Stage 2: 간접 영향 분석 (미정)
    - 산업/섹터 키워드로 관련 종목 확장
    - 결과: 간접 연관 종목 리스트
    ↓
Stage 3: 히스토리 연관성 (미정)
    - 과거 유사 뉴스와의 연결
    ↓
Stage 4: 최종 스코어링 (미정)
    - 종합해서 종목별 연관도 점수
    ↓
[분석 결과 저장]
```

## Stage 1: 직접 매칭 - 방식 검토 결과

### 검토한 방식들

| 방식 | 장점 | 단점 | 결론 |
|------|------|------|------|
| 키워드 매칭 | 빠름, 무료 | 약어(삼전), 띄어쓰기(삼성 전자) 처리 어려움 | X |
| NER 모델 | 사전 관리 불필요 | 약어/간접표현 못 잡음, 키워드와 한계 비슷 | X |
| 로컬 LLM | 약어/띄어쓰기 처리, 문맥 이해 | 속도 | **채택** |

### 로컬 LLM 검증 결과

**환경:**
- 메인: 맥미니 M4 24GB
- 예비: 데스크탑 RTX 4070 12GB (더 빠름)

**테스트한 모델:**
- `qwen2.5:1.5b` → 정확도 부족 (삼성전자만 추출, 교보증권 누락)
- `qwen2.5:3b` → 여전히 부족 (넷플릭스 누락)
- `qwen2.5:7b` → **테스트 필요** (예상: 4-5GB 메모리, 충분히 가능)

**효과적인 프롬프트 패턴:**
```bash
echo "텍스트에서 회사 이름만 추출해. 다른 설명 없이 이름만 쉼표로 나열해.

텍스트: $(cat news.txt)

회사 이름:" | ollama run qwen2.5:7b
```

**Few-shot 프롬프트 (정확도 개선용):**
```bash
echo "텍스트에서 회사/기업 이름만 추출해. 다른 설명 없이 이름만 쉼표로 나열해.

예시1)
텍스트: 삼성전자가 반도체 투자를 발표했고 SK하이닉스도 동참했다.
회사 이름: 삼성전자, SK하이닉스

예시2)
텍스트: 넷플릭스에서 새 드라마가 공개됐고 교보문고 베스트셀러에 올랐다.
회사 이름: 넷플릭스, 교보문고

본문)
텍스트: $(cat news.txt)
회사 이름:" | ollama run qwen2.5:7b
```

## 다음 할 일

### 1. 7b 모델 정확도 테스트
```bash
ollama pull qwen2.5:7b
# 여러 뉴스로 테스트해서 실제 정확도 확인
```

### 2. 파이프라인 상세 설계
- Ollama API 연동 방식 (HTTP API: localhost:11434)
- 추출된 기업명 → 종목 DB 매칭 로직
- 결과 저장 테이블 구조
- 배치 스케줄링 방식

### 3. 구현
- Spring에서 Ollama API 호출
- 뉴스 배치 처리 스케줄러

## 미결 사항 (zina 확인 필요)

1. **종목 마스터 데이터**
   - 기업명 → 종목코드 매칭에 필요
   - KRX에서 종목 목록 크롤링 이미 하고 있는지?
   - 없으면 새로 수집 필요

2. **매칭 결과 저장 구조**
   - 뉴스 1개 : 종목 N개 관계?
   - 연관도 점수 필요?

3. **처리 시점**
   - 뉴스 수집할 때 바로? 배치로 나중에?

## 메모

- Ollama 모델은 5분 유휴 시 자동 언로드됨
- 수동 언로드: `ollama stop <model>`
- 로드 상태 확인: `ollama ps`
- 3b 모델 = 약 2GB 메모리 사용, 7b = 약 4-5GB
